{
    "componentChunkName": "component---node-modules-gatsby-theme-code-notes-src-templates-note-js",
    "path": "/vacuum-sensor-things-postgre-sql-database",
    "result": {"data":{"mdx":{"body":"var _excluded = [\"components\"];\n\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"VACUUM PostgreSQL Database\",\n  \"emoji\": \"üìù\",\n  \"tags\": [\"postgresql\", \"sensorThings API\", \"sql\", \"database\", \"analysis\"],\n  \"created\": \"2020-07-06T16:46:50.000Z\",\n  \"modified\": \"2021-04-20T16:05:46.000Z\"\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, _excluded);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"h2\", {\n    \"id\": \"solution\"\n  }, \"Solution\"), mdx(\"p\", null, \"After running the STA server for several months, the EC2 may have enough disk space due to bloated database tables. You can use PostgreSQL \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"VACUUM\"), \" command to return space to the OS.\"), mdx(\"p\", null, \"Here is the step by step process:\"), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Login to the STA EC2 Instance\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Check the disk usage\")), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"df -h\\n\")), mdx(\"ol\", {\n    \"start\": 3\n  }, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Login to the PostgreSQL Database\")), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"sudo su postgres\\npsql -d sensorthings\\n\")), mdx(\"ol\", {\n    \"start\": 4\n  }, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Check the last time your tables were vacuumed, analyzed, live and dead tup\")), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-SQL\"\n  }, \"SELECT relname, n_live_tup, n_dead_tup, last_vacuum, last_autovacuum\\nFROM pg_stat_all_tables\\nORDER BY n_dead_tup\\n    /(n_live_tup\\n        * current_setting('autovacuum_vacuum_scale_factor')::float8\\n        + current_setting('autovacuum_vacuum_threshold')::float8)\\n     DESC\\nLIMIT 12;\\n\\nResults:\\n       relname       | n_live_tup | n_dead_tup |          last_vacuum\\n---------------------+------------+------------+-------------------------------\\n pg_class            |        367 |         75 | 2018-09-05 22:28:22.941349+00\\n pg_statistic        |        499 |         58 | 2018-09-05 22:11:16.729493+00\\n pg_index            |        150 |         23 | 2018-09-05 22:28:22.95605+00\\n pg_toast_2619       |         32 |         16 | 2018-09-05 22:11:16.730219+00\\n pg_attribute        |       2734 |        128 | 2018-09-05 22:28:22.874761+00\\n pg_type             |        411 |         27 | 2018-09-05 22:11:16.829871+00\\n location            |       2660 |         55 | 2018-09-05 22:11:16.73436+00\\n pg_depend           |       9388 |        177 | 2018-09-05 22:28:23.072771+00\\n data_stream         |       2660 |         45 | 2018-09-05 22:28:22.737992+00\\n observation         |   56042655 |     172199 | 2018-09-13 21:20:39.68152+00\\n feature_of_interest |       2350 |          6 | 2018-09-05 22:28:22.778667+00\\n(11 rows)\\n\")), mdx(\"p\", null, \"If your bloated table does not show up here, n_dead_tup is zero and last_autovacuum is NULL, you might have \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://www.cybertec-postgresql.com/en/stale-statistics-cause-table-bloat/\"\n  }, \"a problem with the statistics collector\"), \".\"), mdx(\"p\", null, \"If the bloated table is right there on top, but last_autovacuum is NULL, you might need to configure autovacuum to be more aggressive so that it gets done with the table.\"), mdx(\"ol\", {\n    \"start\": 5\n  }, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Vacuum the table\")), mdx(\"p\", null, \"The \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"observation\"), \" table usually is the biggest table in the database. It has the largest dead tuples as well.\"), mdx(\"p\", null, mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"BE CAREFUL.\"), \" \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"VACUUM FULL\"), \" is only needed when you have a table that is mostly dead rows - i.e after unnecessary historical data has been deleted by the cron task. It should not be used for table optimization or periodic maintenance, as it's generally counterproductive.\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Plain \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"VACUUM\"), \": Deletes dead tuples and frees up space for re-use\")), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-SQL\"\n  }, \"VACUUM observation;\\n\")), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"Full VACUUM\"), \": Locks the database table, and reclaims more space than a plain but doesn't delete dead tuples\")), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-SQL\"\n  }, \"VACUUM FULL observation;\\n\")), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"Notice\"), \": \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"VACUUM FULL\"), \" is much slower than a normal \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"VACUUM\"), \", so the table may be unavailable for a while.\\nYou might need extra volume to execute \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"VACUUM FULL\"), \" command. Because it requires extra disk space for the new copy of the table until the operation completes. To do that:\")), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Login to your AWS Web console\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Go to EC2\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Select the instance that you want to extend\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Go to the mounted boot volume\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Click Modify Volume\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Change the size field to whatever value you need\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Click the Modify button to apply the changes\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Finally, restart the EC2 instance that links to the EBS volume.\")), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"Notice\"), \":The size of a volume can only be \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"increased\"), \", not \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"decreased\"), \".\")), mdx(\"ol\", {\n    \"start\": 6\n  }, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Set up autovacuum\")), mdx(\"p\", null, \"To prevent our tables from continually getting messy in the future and having to manually\\xA0\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"VACUUM\"), \" and \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"ANALYZE\"), \", you can make the default auto-vacuum settings stricter. \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Postgres\"), \" runs a daemon to regularly vacuum and analyze itself.\"), mdx(\"p\", null, \"Tables are auto-vacuumed when 20% of the rows plus 50 rows are inserted, updated or deleted, and auto-analyzed similarly at 10%, and 50-row thresholds. These settings work fine for smaller tables, but as a table grows to have millions of rows, there can be tens of thousands of inserts or updates before the table is vacuumed and analyzed.\"), mdx(\"p\", null, \"Below is an example which will\\xA0\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"VACUUM\"), \"\\xA0and\\xA0\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"ANALYZE\"), \"\\xA0after 5,000 inserts, updates, or deletes.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-SQL\"\n  }, \"ALTER TABLE observation SET (autovacuum_vacuum_scale_factor = 0.0);\\nALTER TABLE observation SET (autovacuum_vacuum_threshold = 5000);\\nALTER TABLE observation SET (autovacuum_analyze_scale_factor = 0.0);\\nALTER TABLE observation SET (autovacuum_analyze_threshold = 5000);\\n\")), mdx(\"p\", null, \"The threshold to \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"auto-vacuum\"), \" is calculated by:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\"\n  }, \"vacuum threshold = autovacuum_vacuum_threshold + autovacuum_vacuum_scale_factor * number of rows in table\\n\")), mdx(\"p\", null, \"Similarly, the threshold to auto-analyze is calculated by:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\"\n  }, \"analyze threshold = autovacuum_analyze_threshold + autovacuum_analyze_scale_factor * number of rows in table\\n\")), mdx(\"p\", null, \"However, autovacuum sometimes doesn't free the dead tuples.\\nYou can verify the problem by running \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"VACUUM(VERBOSE)\")), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-SQL\"\n  }, \"VACUUM (VERBOSE) observation;\\n\")), mdx(\"h2\", {\n    \"id\": \"why-we-need-vacuum\"\n  }, \"Why we need VACUUM\"), mdx(\"p\", null, \"When you perform \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"UPDATE\"), \" and \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"DELETE\"), \" operations on a table in Postgres, the database has to keep around the old row data for concurrently running queries and transactions, due to its MVCC model. Once all concurrent transactions that have seen these old rows have finished, they effectively become dead rows which will need to be removed.\"), mdx(\"p\", null, mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"VACUUM\"), \" is the process by which PostgreSQL cleans up these dead rows, and turns the space they have occupied into usable space again, to be used for future writes.\"), mdx(\"p\", null, \"A more detailed description can be found in the\\xA0\", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://www.postgresql.org/docs/10/static/routine-vacuuming.html\"\n  }, \"PostgreSQL documentation\"), \".\"), mdx(\"h2\", {\n    \"id\": \"which-tables-have-vacuum-running\"\n  }, \"Which tables have VACUUM running?\"), mdx(\"p\", null, \"The easiest thing you can check on a running PostgreSQL system is which VACUUM operations are running right now. In all Postgres versions this information shows up in the\\xA0\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"pg_stat_activity\"), \"\\xA0view, look for query values that start with \\\"autovacuum: \\\", or which contain the word \\\"VACUUM\\\":\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-SQL\"\n  }, \"SELECT pid, query FROM pg_stat_activity WHERE query LIKE 'autovacuum: %';\\n\")), mdx(\"h2\", {\n    \"id\": \"vacuum-metrics-to-monitor\"\n  }, \"VACUUM metrics to monitor\"), mdx(\"p\", null, \"In order to ensure that VACUUMs are running smoothly across your databases, you should monitor:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"https://www.datadoghq.com/blog/postgresql-vacuum-monitoring/#dead-rows\"\n  }, \"dead rows\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"https://www.datadoghq.com/blog/postgresql-vacuum-monitoring/#table-disk-usage\"\n  }, \"table disk usage\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"https://www.datadoghq.com/blog/postgresql-vacuum-monitoring/#last-time-autovacuum-ran\"\n  }, \"the last time a VACUUM or AUTOVACUUM ran\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"https://www.datadoghq.com/blog/postgresql-vacuum-monitoring/#correlating-vacuums-with-metrics\"\n  }, \"manual/nightly VACUUM events\"))), mdx(\"h2\", {\n    \"id\": \"why-wont-vacuum-remove-the-dead-rows\"\n  }, \"Why won\\u2019t VACUUM remove the dead rows?\"), mdx(\"p\", null, \"VACUUM can only remove those row versions (also known as \\u201Ctuples\\u201D) that are not needed any more. A tuple is not needed if the transaction ID of the deleting transaction (as stored in the xmax system column) is older than the oldest transaction still active in the PostgreSQL database (or the whole cluster for shared tables).\"), mdx(\"p\", null, \"This value is called the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"xmin horizon\"), \".\"), mdx(\"p\", null, \"There are three things that can hold back this xmin horizon in a PostgreSQL cluster:\"), mdx(\"h3\", {\n    \"id\": \"1long-running-transactions\"\n  }, \"1.Long-running transactions:\"), mdx(\"p\", null, \"You can find those and their xmin value with the following query:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-SQL\"\n  }, \"SELECT pid, datname, usename, state, backend_xmin\\nFROM pg_stat_activity\\nWHERE backend_xmin IS NOT NULL\\nORDER BY age(backend_xmin) DESC;\\n\")), mdx(\"p\", null, \"You can use the \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://www.postgresql.org/docs/current/static/functions-admin.html#FUNCTIONS-ADMIN-SIGNAL\"\n  }, \"pg_terminate_backend()\"), \" function to terminate the database session that is blocking your VACUUM.\"), mdx(\"h3\", {\n    \"id\": \"2abandoned-replication-slots\"\n  }, \"2.Abandoned replication slots:\"), mdx(\"p\", null, \"A replication slot is a data structure that keeps the PostgreSQL server from discarding information that is still needed by a standby server to catch up with the primary.\"), mdx(\"p\", null, \"If replication is delayed or the standby server is down, the replication slot will prevent VACUUM from deleting old rows.\"), mdx(\"p\", null, \"You can find all replication slots and their xmin value with this query:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-SQL\"\n  }, \"SELECT slot_name, slot_type, database, xmin\\nFROM pg_replication_slots\\nORDER BY age(xmin) DESC;\\n\")), mdx(\"p\", null, \"Use the \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://www.postgresql.org/docs/current/static/functions-admin.html#FUNCTIONS-REPLICATION\"\n  }, \"pg_drop_replication_slot()\"), \" function to drop replication slots that are no longer needed.\"), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"Note\"), \": This can only happen with physical replication if hot_standby_feedback = on. For logical replication there is a similar hazard, but only system catalogs are affected. Examine the column catalog_xmin in that case.\")), mdx(\"h3\", {\n    \"id\": \"3orphaned-prepared-transactions\"\n  }, \"3.Orphaned prepared transactions:\"), mdx(\"p\", null, \"During \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://en.wikipedia.org/wiki/Two-phase_commit_protocol\"\n  }, \"two-phase commit\"), \", a distributed transaction is first prepared with the \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://www.postgresql.org/docs/current/static/sql-prepare-transaction.html\"\n  }, \"PREPARE\"), \" statement and then committed with the \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://www.postgresql.org/docs/current/static/sql-commit-prepared.html\"\n  }, \"COMMIT PREPARED\"), \" statement.\"), mdx(\"p\", null, \"Once a transaction has been prepared, it is kept \\u201Changing around\\u201D until it is committed or aborted. It even has to survive a server restart! Normally, transactions don\\u2019t remain in the prepared state for long, but sometimes things go wrong and a prepared transaction has to be removed manually by an administrator.\"), mdx(\"p\", null, \"You can find all prepared transactions and their xmin value with the following query:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-SQL\"\n  }, \"SELECT gid, prepared, owner, database, transaction AS xmin\\nFROM pg_prepared_xacts\\nORDER BY age(transaction) DESC;\\n\")), mdx(\"p\", null, \"Use the \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://www.postgresql.org/docs/current/static/sql-rollback-prepared.html\"\n  }, \"ROLLBACK PREPARED SQL\"), \" statement to remove prepared transactions.\"), mdx(\"h2\", {\n    \"id\": \"analyze\"\n  }, \"ANALYZE\"), mdx(\"p\", null, mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"ANALYZE\"), \"\\xA0gathers statistics for the query planner to create the most efficient query execution paths. Per PostgreSQL documentation, accurate statistics will help the planner to choose the most appropriate query plan, and thereby improve the speed of query processing.\"), mdx(\"p\", null, mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"Example\"), \"\\nIn the example below, \", \"[tablename]\", \" is optional. Without a table specified, ANALYZE will be run on available tables in the current schema that the user has access to.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-SQL\"\n  }, \"ANALYZE VERBOSE [tablename]\\n\")), mdx(\"h2\", {\n    \"id\": \"reindex\"\n  }, \"REINDEX\"), mdx(\"p\", null, \"The\\xA0REINDEX\\xA0command rebuilds one or more indices, replacing the previous version of the index. REINDEX can be used in many scenarios, e.g., an index has become\\xA0\\\"bloated\\\".\"), mdx(\"p\", null, mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"Examples\"), \"\\nAny of these can be forced by adding the keyword\\xA0FORCE\\xA0after the command\"), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Recreate a single index,\\xA0myindex:\")), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-SQL\"\n  }, \"REINDEX INDEX myindex\\n\")), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Recreate all indices in a table, observation:\")), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-SQL\"\n  }, \"REINDEX TABLE observation;\\n\")), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Recreate all indices in sensorthings:\")), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-SQL\"\n  }, \"REINDEX DATABASE sensorthings;\\n\")), mdx(\"h2\", {\n    \"id\": \"some-useful-postgresql-commands\"\n  }, \"Some useful PostgreSQL commands\"), mdx(\"h3\", {\n    \"id\": \"show-tables\"\n  }, \"Show tables\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-SQL\"\n  }, \"\\\\dt\\n\\nResults:\\n               List of relations\\nSchema |        Name         | Type  |  Owner\\n--------+---------------------+-------+----------\\npublic | data_stream         | table | postgres\\npublic | feature_of_interest | table | postgres\\npublic | historical_location | table | postgres\\npublic | location            | table | postgres\\npublic | observation         | table | postgres\\npublic | observation_archive | table | postgres\\npublic | observed_property   | table | postgres\\npublic | sensor              | table | postgres\\npublic | spatial_ref_sys     | table | postgres\\npublic | thing               | table | postgres\\npublic | thing_location      | table | postgres\\n(11 rows)\\n\")), mdx(\"ol\", {\n    \"start\": 4\n  }, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Check database/table disk usage\")), mdx(\"h3\", {\n    \"id\": \"table-disk-usage\"\n  }, \"Table disk usage\"), mdx(\"p\", null, \"Tracking the amount of disk space used by each table is important because it enables you to gauge expected changes in query performance over time\\u2014but it can also help you detect potential vacuuming-related issues.\"), mdx(\"p\", null, \"The following query shows you the table that is using the most disk space in your database:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Check database disk usage\")), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-SQL\"\n  }, \"SELECT pg_size_pretty(pg_database_size('sensorthings'));\\n\")), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Check each table disk usage\")), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-SQL\"\n  }, \"SELECT\\n       relname AS \\\"table_name\\\",\\n       pg_size_pretty(pg_table_size(C.oid)) AS \\\"table_size\\\"\\nFROM\\n       pg_class C\\nLEFT JOIN pg_namespace N ON (N.oid = C.relnamespace)\\nWHERE nspname NOT IN ('pg_catalog', 'information_schema') AND nspname !~ '^pg_toast' AND relkind IN ('r')\\nORDER BY pg_table_size(C.oid)\\nDESC LIMIT 11;\\n\\nResults:\\n     table_name      | table_size\\n---------------------+------------\\n observation         | 4156 MB\\n data_stream         | 8056 kB\\n spatial_ref_sys     | 3984 kB\\n feature_of_interest | 2248 kB\\n location            | 1864 kB\\n thing               | 1672 kB\\n historical_location | 168 kB\\n thing_location      | 120 kB\\n sensor              | 16 kB\\n observed_property   | 16 kB\\n observation_archive | 8192 bytes\\n\")), mdx(\"h3\", {\n    \"id\": \"check-dead-rows\"\n  }, \"Check dead rows\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-SQL\"\n  }, \"SELECT relname, n_dead_tup\\nFROM pg_stat_user_tables\\nORDER BY n_dead_tup DESC;\\n\\nResults:\\n       relname       | n_dead_tup\\n---------------------+------------\\n observation         |     176199\\n location            |         55\\n data_stream         |         45\\n feature_of_interest |          6\\n sensor              |          0\\n observation_archive |          0\\n thing               |          0\\n thing_location      |          0\\n observed_property   |          0\\n spatial_ref_sys     |          0\\n historical_location |          0\\n\")));\n}\n;\nMDXContent.isMDXComponent = true;","frontmatter":{"title":"VACUUM PostgreSQL Database","tags":["postgresql","sensorThings API","sql","database","analysis"],"emoji":"üìù","link":null,"modified":"April 20, 2021","modifiedTimestamp":"2021-04-20T16:05:46.000Z"},"references":[],"fields":{"slug":"/vacuum_sensor_things_postgre_sql_database"},"tableOfContents":{"items":[{"url":"#solution","title":"Solution"},{"url":"#why-we-need-vacuum","title":"Why we need VACUUM"},{"url":"#which-tables-have-vacuum-running","title":"Which tables have VACUUM running?"},{"url":"#vacuum-metrics-to-monitor","title":"VACUUM metrics to monitor"},{"url":"#why-wont-vacuum-remove-the-dead-rows","title":"Why won‚Äôt VACUUM remove the dead rows?","items":[{"url":"#1long-running-transactions","title":"1.Long-running transactions:"},{"url":"#2abandoned-replication-slots","title":"2.Abandoned replication slots:"},{"url":"#3orphaned-prepared-transactions","title":"3.Orphaned prepared transactions:"}]},{"url":"#analyze","title":"ANALYZE"},{"url":"#reindex","title":"REINDEX"},{"url":"#some-useful-postgresql-commands","title":"Some useful PostgreSQL commands","items":[{"url":"#show-tables","title":"Show tables"},{"url":"#table-disk-usage","title":"Table disk usage"},{"url":"#check-dead-rows","title":"Check dead rows"}]}]},"parent":{"relativePath":"vacuum_sensor_things_postgre_sql_database.md"}}},"pageContext":{"id":"3c267535-b5dc-53f2-b07a-d15a3f9b9b3a","previous":{"id":"6566c51f-2272-5212-9331-341b30294d18","frontmatter":{"title":"Validate Binary Search Tree","tags":["leetcode","bst","tree","algorithm"]},"fields":{"slug":"/validate_binary_search_tree"}},"next":{"id":"8af21553-b093-571d-abb6-6bff901f794f","frontmatter":{"title":"Using Blockchain for Trustworthy Mobile Contract Tracing","tags":["research","blockchain","iot","security"]},"fields":{"slug":"/using_blockchain_for_trustworthy_mobile_contract_tracing"}},"hasUntagged":true,"basePath":"/","tags":[{"tag":"Archived","totalCount":3,"slug":"/archived","path":"/tag/archived"},{"tag":"Ethereum","totalCount":3,"slug":"/ethereum","path":"/tag/ethereum"},{"tag":"NFT","totalCount":1,"slug":"/nft","path":"/tag/nft"},{"tag":"UI/UX","totalCount":1,"slug":"/uiux","path":"/tag/uiux"},{"tag":"academic","totalCount":2,"slug":"/academic","path":"/tag/academic"},{"tag":"ai","totalCount":4,"slug":"/ai","path":"/tag/ai"},{"tag":"algorithm","totalCount":13,"slug":"/algorithm","path":"/tag/algorithm"},{"tag":"analysis","totalCount":3,"slug":"/analysis","path":"/tag/analysis"},{"tag":"api","totalCount":5,"slug":"/api","path":"/tag/api"},{"tag":"apollo","totalCount":1,"slug":"/apollo","path":"/tag/apollo"},{"tag":"architecture","totalCount":2,"slug":"/architecture","path":"/tag/architecture"},{"tag":"asciidoc","totalCount":3,"slug":"/asciidoc","path":"/tag/asciidoc"},{"tag":"audio","totalCount":1,"slug":"/audio","path":"/tag/audio"},{"tag":"automation","totalCount":1,"slug":"/automation","path":"/tag/automation"},{"tag":"aws","totalCount":9,"slug":"/aws","path":"/tag/aws"},{"tag":"bash","totalCount":2,"slug":"/bash","path":"/tag/bash"},{"tag":"basketball","totalCount":2,"slug":"/basketball","path":"/tag/basketball"},{"tag":"best-practices","totalCount":3,"slug":"/best-practices","path":"/tag/best-practices"},{"tag":"big data","totalCount":3,"slug":"/big-data","path":"/tag/big-data"},{"tag":"blockchain","totalCount":15,"slug":"/blockchain","path":"/tag/blockchain"},{"tag":"book","totalCount":2,"slug":"/book","path":"/tag/book"},{"tag":"bst","totalCount":1,"slug":"/bst","path":"/tag/bst"},{"tag":"career","totalCount":2,"slug":"/career","path":"/tag/career"},{"tag":"cell","totalCount":1,"slug":"/cell","path":"/tag/cell"},{"tag":"chart","totalCount":1,"slug":"/chart","path":"/tag/chart"},{"tag":"cheatsheet","totalCount":2,"slug":"/cheatsheet","path":"/tag/cheatsheet"},{"tag":"chrome","totalCount":1,"slug":"/chrome","path":"/tag/chrome"},{"tag":"cli","totalCount":11,"slug":"/cli","path":"/tag/cli"},{"tag":"cloud","totalCount":1,"slug":"/cloud","path":"/tag/cloud"},{"tag":"code review","totalCount":1,"slug":"/code-review","path":"/tag/code-review"},{"tag":"code-review","totalCount":1,"slug":"/code-review","path":"/tag/code-review"},{"tag":"communication","totalCount":4,"slug":"/communication","path":"/tag/communication"},{"tag":"contact tracking","totalCount":1,"slug":"/contact-tracking","path":"/tag/contact-tracking"},{"tag":"container","totalCount":1,"slug":"/container","path":"/tag/container"},{"tag":"converter","totalCount":1,"slug":"/converter","path":"/tag/converter"},{"tag":"covid19","totalCount":1,"slug":"/covid19","path":"/tag/covid19"},{"tag":"crypto","totalCount":1,"slug":"/crypto","path":"/tag/crypto"},{"tag":"cryptography","totalCount":1,"slug":"/cryptography","path":"/tag/cryptography"},{"tag":"csv","totalCount":1,"slug":"/csv","path":"/tag/csv"},{"tag":"data","totalCount":1,"slug":"/data","path":"/tag/data"},{"tag":"data science","totalCount":1,"slug":"/data-science","path":"/tag/data-science"},{"tag":"database","totalCount":11,"slug":"/database","path":"/tag/database"},{"tag":"design","totalCount":3,"slug":"/design","path":"/tag/design"},{"tag":"dev","totalCount":1,"slug":"/dev","path":"/tag/dev"},{"tag":"develop","totalCount":1,"slug":"/develop","path":"/tag/develop"},{"tag":"development","totalCount":1,"slug":"/development","path":"/tag/development"},{"tag":"devops","totalCount":1,"slug":"/devops","path":"/tag/devops"},{"tag":"discipline","totalCount":1,"slug":"/discipline","path":"/tag/discipline"},{"tag":"distributed","totalCount":1,"slug":"/distributed","path":"/tag/distributed"},{"tag":"docker","totalCount":5,"slug":"/docker","path":"/tag/docker"},{"tag":"docx","totalCount":1,"slug":"/docx","path":"/tag/docx"},{"tag":"dog","totalCount":1,"slug":"/dog","path":"/tag/dog"},{"tag":"duckdb","totalCount":1,"slug":"/duckdb","path":"/tag/duckdb"},{"tag":"dynamodb","totalCount":2,"slug":"/dynamodb","path":"/tag/dynamodb"},{"tag":"edr","totalCount":1,"slug":"/edr","path":"/tag/edr"},{"tag":"education","totalCount":1,"slug":"/education","path":"/tag/education"},{"tag":"efficiency","totalCount":1,"slug":"/efficiency","path":"/tag/efficiency"},{"tag":"emergency","totalCount":1,"slug":"/emergency","path":"/tag/emergency"},{"tag":"engineering","totalCount":1,"slug":"/engineering","path":"/tag/engineering"},{"tag":"error-handling","totalCount":1,"slug":"/error-handling","path":"/tag/error-handling"},{"tag":"eslint","totalCount":1,"slug":"/eslint","path":"/tag/eslint"},{"tag":"ethereum","totalCount":2,"slug":"/ethereum","path":"/tag/ethereum"},{"tag":"experience","totalCount":1,"slug":"/experience","path":"/tag/experience"},{"tag":"functional","totalCount":1,"slug":"/functional","path":"/tag/functional"},{"tag":"game","totalCount":1,"slug":"/game","path":"/tag/game"},{"tag":"gis","totalCount":27,"slug":"/gis","path":"/tag/gis"},{"tag":"git","totalCount":5,"slug":"/git","path":"/tag/git"},{"tag":"github","totalCount":4,"slug":"/github","path":"/tag/github"},{"tag":"google","totalCount":3,"slug":"/google","path":"/tag/google"},{"tag":"graphql","totalCount":4,"slug":"/graphql","path":"/tag/graphql"},{"tag":"handbook","totalCount":1,"slug":"/handbook","path":"/tag/handbook"},{"tag":"hash","totalCount":1,"slug":"/hash","path":"/tag/hash"},{"tag":"hci","totalCount":1,"slug":"/hci","path":"/tag/hci"},{"tag":"health","totalCount":1,"slug":"/health","path":"/tag/health"},{"tag":"image","totalCount":1,"slug":"/image","path":"/tag/image"},{"tag":"immunotherapies","totalCount":1,"slug":"/immunotherapies","path":"/tag/immunotherapies"},{"tag":"infrastructure","totalCount":1,"slug":"/infrastructure","path":"/tag/infrastructure"},{"tag":"insights","totalCount":1,"slug":"/insights","path":"/tag/insights"},{"tag":"interface","totalCount":1,"slug":"/interface","path":"/tag/interface"},{"tag":"interoperability","totalCount":2,"slug":"/interoperability","path":"/tag/interoperability"},{"tag":"interview","totalCount":3,"slug":"/interview","path":"/tag/interview"},{"tag":"investment","totalCount":1,"slug":"/investment","path":"/tag/investment"},{"tag":"iot","totalCount":12,"slug":"/iot","path":"/tag/iot"},{"tag":"javascript","totalCount":19,"slug":"/javascript","path":"/tag/javascript"},{"tag":"js","totalCount":13,"slug":"/js","path":"/tag/js"},{"tag":"json","totalCount":1,"slug":"/json","path":"/tag/json"},{"tag":"jupyter","totalCount":2,"slug":"/jupyter","path":"/tag/jupyter"},{"tag":"kubernetes","totalCount":1,"slug":"/kubernetes","path":"/tag/kubernetes"},{"tag":"laws","totalCount":1,"slug":"/laws","path":"/tag/laws"},{"tag":"leadership","totalCount":1,"slug":"/leadership","path":"/tag/leadership"},{"tag":"leetcode","totalCount":8,"slug":"/leetcode","path":"/tag/leetcode"},{"tag":"life","totalCount":1,"slug":"/life","path":"/tag/life"},{"tag":"linear algebra","totalCount":1,"slug":"/linear-algebra","path":"/tag/linear-algebra"},{"tag":"linux","totalCount":1,"slug":"/linux","path":"/tag/linux"},{"tag":"log","totalCount":1,"slug":"/log","path":"/tag/log"},{"tag":"luxon","totalCount":1,"slug":"/luxon","path":"/tag/luxon"},{"tag":"machine learning","totalCount":2,"slug":"/machine-learning","path":"/tag/machine-learning"},{"tag":"macos","totalCount":5,"slug":"/macos","path":"/tag/macos"},{"tag":"management","totalCount":193,"slug":"/management","path":"/tag/management"},{"tag":"mapbox","totalCount":1,"slug":"/mapbox","path":"/tag/mapbox"},{"tag":"markdown","totalCount":1,"slug":"/markdown","path":"/tag/markdown"},{"tag":"math","totalCount":1,"slug":"/math","path":"/tag/math"},{"tag":"methodology","totalCount":1,"slug":"/methodology","path":"/tag/methodology"},{"tag":"microservices","totalCount":2,"slug":"/microservices","path":"/tag/microservices"},{"tag":"mobile","totalCount":1,"slug":"/mobile","path":"/tag/mobile"},{"tag":"models","totalCount":1,"slug":"/models","path":"/tag/models"},{"tag":"moment","totalCount":1,"slug":"/moment","path":"/tag/moment"},{"tag":"mqtt","totalCount":2,"slug":"/mqtt","path":"/tag/mqtt"},{"tag":"negotiation","totalCount":1,"slug":"/negotiation","path":"/tag/negotiation"},{"tag":"node","totalCount":5,"slug":"/node","path":"/tag/node"},{"tag":"nodejs","totalCount":3,"slug":"/nodejs","path":"/tag/nodejs"},{"tag":"note","totalCount":23,"slug":"/note","path":"/tag/note"},{"tag":"npm","totalCount":1,"slug":"/npm","path":"/tag/npm"},{"tag":"oauth","totalCount":1,"slug":"/oauth","path":"/tag/oauth"},{"tag":"object detection","totalCount":2,"slug":"/object-detection","path":"/tag/object-detection"},{"tag":"odata","totalCount":1,"slug":"/odata","path":"/tag/odata"},{"tag":"ogc","totalCount":9,"slug":"/ogc","path":"/tag/ogc"},{"tag":"openapi","totalCount":1,"slug":"/openapi","path":"/tag/openapi"},{"tag":"operators","totalCount":1,"slug":"/operators","path":"/tag/operators"},{"tag":"orchestrator","totalCount":1,"slug":"/orchestrator","path":"/tag/orchestrator"},{"tag":"pandoc","totalCount":2,"slug":"/pandoc","path":"/tag/pandoc"},{"tag":"parent","totalCount":1,"slug":"/parent","path":"/tag/parent"},{"tag":"patterns","totalCount":1,"slug":"/patterns","path":"/tag/patterns"},{"tag":"performance","totalCount":2,"slug":"/performance","path":"/tag/performance"},{"tag":"personal-growth","totalCount":82,"slug":"/personal-growth","path":"/tag/personal-growth"},{"tag":"pet","totalCount":1,"slug":"/pet","path":"/tag/pet"},{"tag":"philosophy","totalCount":1,"slug":"/philosophy","path":"/tag/philosophy"},{"tag":"pipeline","totalCount":1,"slug":"/pipeline","path":"/tag/pipeline"},{"tag":"pipenv","totalCount":1,"slug":"/pipenv","path":"/tag/pipenv"},{"tag":"pm2","totalCount":1,"slug":"/pm2","path":"/tag/pm2"},{"tag":"point free","totalCount":1,"slug":"/point-free","path":"/tag/point-free"},{"tag":"postgresql","totalCount":3,"slug":"/postgresql","path":"/tag/postgresql"},{"tag":"presentation","totalCount":2,"slug":"/presentation","path":"/tag/presentation"},{"tag":"principles","totalCount":1,"slug":"/principles","path":"/tag/principles"},{"tag":"privacy","totalCount":1,"slug":"/privacy","path":"/tag/privacy"},{"tag":"problem solving","totalCount":1,"slug":"/problem-solving","path":"/tag/problem-solving"},{"tag":"program","totalCount":2,"slug":"/program","path":"/tag/program"},{"tag":"programming","totalCount":5,"slug":"/programming","path":"/tag/programming"},{"tag":"provenance","totalCount":1,"slug":"/provenance","path":"/tag/provenance"},{"tag":"psychology","totalCount":3,"slug":"/psychology","path":"/tag/psychology"},{"tag":"python","totalCount":7,"slug":"/python","path":"/tag/python"},{"tag":"react","totalCount":7,"slug":"/react","path":"/tag/react"},{"tag":"reading","totalCount":1,"slug":"/reading","path":"/tag/reading"},{"tag":"reasoning","totalCount":1,"slug":"/reasoning","path":"/tag/reasoning"},{"tag":"regex","totalCount":1,"slug":"/regex","path":"/tag/regex"},{"tag":"relationship","totalCount":1,"slug":"/relationship","path":"/tag/relationship"},{"tag":"remote","totalCount":1,"slug":"/remote","path":"/tag/remote"},{"tag":"remote-work","totalCount":1,"slug":"/remote-work","path":"/tag/remote-work"},{"tag":"research","totalCount":7,"slug":"/research","path":"/tag/research"},{"tag":"resources","totalCount":1,"slug":"/resources","path":"/tag/resources"},{"tag":"ruby","totalCount":1,"slug":"/ruby","path":"/tag/ruby"},{"tag":"rxjs","totalCount":1,"slug":"/rxjs","path":"/tag/rxjs"},{"tag":"scalable","totalCount":1,"slug":"/scalable","path":"/tag/scalable"},{"tag":"scraping","totalCount":1,"slug":"/scraping","path":"/tag/scraping"},{"tag":"security","totalCount":3,"slug":"/security","path":"/tag/security"},{"tag":"sensorThings API","totalCount":1,"slug":"/sensor-things-api","path":"/tag/sensor-things-api"},{"tag":"serverless","totalCount":1,"slug":"/serverless","path":"/tag/serverless"},{"tag":"sh","totalCount":1,"slug":"/sh","path":"/tag/sh"},{"tag":"shell","totalCount":6,"slug":"/shell","path":"/tag/shell"},{"tag":"spatial","totalCount":2,"slug":"/spatial","path":"/tag/spatial"},{"tag":"sql","totalCount":5,"slug":"/sql","path":"/tag/sql"},{"tag":"sta","totalCount":5,"slug":"/sta","path":"/tag/sta"},{"tag":"startup","totalCount":1,"slug":"/startup","path":"/tag/startup"},{"tag":"step functions","totalCount":1,"slug":"/step-functions","path":"/tag/step-functions"},{"tag":"stock","totalCount":1,"slug":"/stock","path":"/tag/stock"},{"tag":"structures","totalCount":1,"slug":"/structures","path":"/tag/structures"},{"tag":"style","totalCount":1,"slug":"/style","path":"/tag/style"},{"tag":"swe","totalCount":1,"slug":"/swe","path":"/tag/swe"},{"tag":"table","totalCount":1,"slug":"/table","path":"/tag/table"},{"tag":"team","totalCount":2,"slug":"/team","path":"/tag/team"},{"tag":"team-building","totalCount":1,"slug":"/team-building","path":"/tag/team-building"},{"tag":"terraform","totalCount":1,"slug":"/terraform","path":"/tag/terraform"},{"tag":"test","totalCount":2,"slug":"/test","path":"/tag/test"},{"tag":"theories","totalCount":1,"slug":"/theories","path":"/tag/theories"},{"tag":"thinking","totalCount":2,"slug":"/thinking","path":"/tag/thinking"},{"tag":"time","totalCount":3,"slug":"/time","path":"/tag/time"},{"tag":"tips","totalCount":2,"slug":"/tips","path":"/tag/tips"},{"tag":"tools","totalCount":4,"slug":"/tools","path":"/tag/tools"},{"tag":"tree","totalCount":3,"slug":"/tree","path":"/tag/tree"},{"tag":"typescript","totalCount":1,"slug":"/typescript","path":"/tag/typescript"},{"tag":"ubuntu","totalCount":1,"slug":"/ubuntu","path":"/tag/ubuntu"},{"tag":"ui","totalCount":2,"slug":"/ui","path":"/tag/ui"},{"tag":"unix","totalCount":1,"slug":"/unix","path":"/tag/unix"},{"tag":"vaccine","totalCount":1,"slug":"/vaccine","path":"/tag/vaccine"},{"tag":"video","totalCount":1,"slug":"/video","path":"/tag/video"},{"tag":"vscode","totalCount":1,"slug":"/vscode","path":"/tag/vscode"},{"tag":"web","totalCount":13,"slug":"/web","path":"/tag/web"},{"tag":"wine","totalCount":1,"slug":"/wine","path":"/tag/wine"},{"tag":"wkt","totalCount":1,"slug":"/wkt","path":"/tag/wkt"},{"tag":"writing","totalCount":15,"slug":"/writing","path":"/tag/writing"},{"tag":"xml","totalCount":1,"slug":"/xml","path":"/tag/xml"},{"tag":"yarn","totalCount":1,"slug":"/yarn","path":"/tag/yarn"},{"tag":"yolo","totalCount":2,"slug":"/yolo","path":"/tag/yolo"},{"tag":"zsh","totalCount":1,"slug":"/zsh","path":"/tag/zsh"}]}},
    "staticQueryHashes": ["1308211557","2744905544","467212769"]}